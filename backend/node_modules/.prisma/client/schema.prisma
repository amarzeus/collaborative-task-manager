generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User model for authentication and task ownership
model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isActive      Boolean        @default(true)
  lastLoginAt   DateTime?
  managerId     String?
  role          Role           @default(USER)
  avatarUrl     String?
  comments      Comment[]
  notifications Notification[]
  taskHistory   TaskHistory[]
  taskTemplates TaskTemplate[]
  assignedTasks Task[]         @relation("AssignedTasks")
  createdTasks  Task[]         @relation("CreatedTasks")
  manager       User?          @relation("ManagerReports", fields: [managerId], references: [id])
  directReports User[]         @relation("ManagerReports")

  @@index([role])
  @@index([isActive])
  @@index([managerId])
  @@map("users")
}

/// Task model with full CRUD support
model Task {
  id            String         @id @default(uuid())
  title         String         @db.VarChar(100)
  description   String
  dueDate       DateTime
  priority      Priority       @default(MEDIUM)
  status        Status         @default(TODO)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  creatorId     String
  assignedToId  String?
  version       Int            @default(1)
  comments      Comment[]
  notifications Notification[]
  history       TaskHistory[]
  assignedTo    User?          @relation("AssignedTasks", fields: [assignedToId], references: [id])
  creator       User           @relation("CreatedTasks", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@map("tasks")
}

/// In-app notifications for task assignments and updates
model Notification {
  id        String   @id @default(uuid())
  message   String
  type      String   @default("task_assigned")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  taskId    String?
  title     String
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

/// Task history for tracking changes and generating analytics
model TaskHistory {
  id        String   @id @default(uuid())
  action    String
  field     String?
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
  taskId    String
  userId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([createdAt])
  @@index([action])
  @@map("task_history")
}

/// Audit log for tracking all admin and system actions
model AuditLog {
  id         String   @id @default(uuid())
  entityType String
  entityId   String
  action     String
  actorId    String
  actorEmail String
  actorIp    String?
  userAgent  String?
  changes    String?
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

/// Reusable task templates for quick task creation
model TaskTemplate {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(50)
  title       String   @db.VarChar(100)
  description String
  priority    Priority @default(MEDIUM)
  isGlobal    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([isGlobal])
  @@map("task_templates")
}

/// Task comments for collaboration
model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  taskId    String
  userId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@map("comments")
}

/// Priority levels for tasks
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

/// Status of a task in the workflow
enum Status {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
}

/// User roles for access control
enum Role {
  USER
  TEAM_LEAD
  MANAGER
  ADMIN
  SUPER_ADMIN
}
